<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèì Schnaggi Pong - Multiplayer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a1a2e;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:'Segoe UI',sans-serif;color:#fff;overflow:hidden;touch-action:none}
h1{font-size:1.8em;margin-bottom:8px;text-shadow:0 0 20px #e94560}
#menu{text-align:center;margin:20px}
button{font-size:1.1em;padding:12px 28px;margin:8px;background:#e94560;color:#fff;border:none;border-radius:8px;cursor:pointer}
button:hover{background:#c73e54}
input{padding:12px;font-size:1.1em;border-radius:8px;border:none;margin:8px;width:260px;text-align:center}
#status{color:#e94560;margin:10px;font-size:1.1em;min-height:2.8em}
canvas{border:3px solid #e94560;border-radius:8px;background:#16213e;display:none}
#scores{font-size:1.4em;margin:8px;display:none}
.p1c{color:#0f0}.p2c{color:#e94560}
#gmsg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2em;font-weight:bold;color:#fff;text-shadow:0 0 30px #e94560;pointer-events:none;opacity:0;transition:opacity 0.3s}
#room-display{background:#16213e;padding:15px 20px;border-radius:8px;margin:10px;font-size:1.1em;display:none;max-width:90vw}
#room-display b{color:#0ff}
.info{color:#888;font-size:0.85em;margin:5px}
a{color:#0ff}
</style>
</head>
<body>
<h1>üèì Schnaggi Pong</h1>
<div id="scores"><span class="p1c">Du: <span id="s1">0</span></span> | <span class="p2c">Gegner: <span id="s2">0</span></span></div>
<canvas id="game" width="600" height="400"></canvas>
<div id="menu">
<div id="status"></div>
<div id="room-display"></div>
<button id="btn-host">Spiel erstellen üéÆ</button>
<button id="btn-join">Beitreten ü§ù</button>
<div id="join-section" style="display:none">
<input id="join-input" placeholder="Raum-Code eingeben...">
<br><button id="btn-connect">Verbinden</button>
</div>
</div>
<div id="gmsg"></div>

<script type="module">
import {joinRoom} from 'https://cdn.jsdelivr.net/npm/trystero/nostr.min.js';

const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const st=document.getElementById('status');
const menu=document.getElementById('menu');
const scoresDiv=document.getElementById('scores');
const gmsg=document.getElementById('gmsg');
const roomDisp=document.getElementById('room-display');

const PW=12,PH=80,BR=8,CW=600,CH=400;
let isHost=false,gameOn=false,myScore=0,theirScore=0,myY=160;
let sendPaddle,sendState,sendEvent;
let state={ball:{x:300,y:200,vx:5,vy:3},p1:{y:160},p2:{y:160}};
let peerJoined=false;

const rtcConfig={
  iceServers:[
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'stun:stun1.l.google.com:19302'},
    {urls:'turn:openrelay.metered.ca:80',username:'openrelayproject',credential:'openrelayproject'},
    {urls:'turn:openrelay.metered.ca:443',username:'openrelayproject',credential:'openrelayproject'},
    {urls:'turn:openrelay.metered.ca:443?transport=tcp',username:'openrelayproject',credential:'openrelayproject'}
  ]
};

const params=new URLSearchParams(location.search);
const joinCode=params.get('r');
if(joinCode){
  document.getElementById('btn-host').style.display='none';
  document.getElementById('btn-join').style.display='none';
  st.innerHTML='Verbinde mit Raum: <b>'+joinCode+'</b>...<br><span class="info">Suche Gegner √ºber Nostr-Relays...</span>';
  connect(joinCode,false);
}

document.getElementById('btn-host').onclick=()=>{
  const code=Math.random().toString(36).slice(2,7).toUpperCase();
  isHost=true;
  document.getElementById('btn-host').style.display='none';
  document.getElementById('btn-join').style.display='none';
  const link=location.origin+location.pathname+'?r='+code;
  roomDisp.style.display='block';
  roomDisp.innerHTML='Raum-Code: <b style="font-size:1.4em">'+code+'</b><br><br>'
    +'Link: <a href="'+link+'">'+link+'</a><br><br>'
    +'<span class="info">Schick den Link oder Code deinem Kumpel!</span>';
  st.innerHTML='Warte auf Gegner... üëÄ<br><span class="info">Verbinde √ºber Nostr-Relays...</span>';
  connect(code,true);
};

document.getElementById('btn-join').onclick=()=>{
  document.getElementById('btn-host').style.display='none';
  document.getElementById('btn-join').style.display='none';
  document.getElementById('join-section').style.display='block';
};

document.getElementById('btn-connect').onclick=()=>{
  const c=document.getElementById('join-input').value.trim().toUpperCase();
  if(!c)return;
  document.getElementById('join-section').style.display='none';
  st.innerHTML='Verbinde mit Raum: <b>'+c+'</b>...<br><span class="info">Suche Gegner √ºber Nostr-Relays...</span>';
  connect(c,false);
};

function connect(code,hosting){
  isHost=hosting;
  const room=joinRoom({appId:'schnaggi-pong-v3',rtcConfig},code);
  
  const [sp,gp]=room.makeAction('p');
  const [ss,gs]=room.makeAction('s');
  const [se,ge]=room.makeAction('e');
  sendPaddle=sp;sendState=ss;sendEvent=se;

  gp(d=>{if(isHost)state.p2.y=d;else state.p1.y=d;});
  gs(d=>{if(!isHost)state=d;});
  ge(d=>{
    if(d.t==='score'){myScore=d.them;theirScore=d.me;updateScores();}
    if(d.t==='msg')showMsg(d.text);
    if(d.t==='start')startGame();
  });

  room.onPeerJoin(pid=>{
    peerJoined=true;
    st.innerHTML='‚úÖ Gegner verbunden!';
    console.log('Peer joined:',pid);
    if(isHost)setTimeout(()=>{sendEvent({t:'start'});startGame();},1500);
  });
  room.onPeerLeave(()=>{
    st.innerHTML='‚ùå Gegner hat verlassen';
    gameOn=false;menu.style.display='block';canvas.style.display='none';scoresDiv.style.display='none';
  });

  // Connection timeout hint
  setTimeout(()=>{
    if(!peerJoined){
      st.innerHTML+=`<br><span class="info">‚è≥ Noch keine Verbindung... Stelle sicher, dass dein Kumpel den Link ge√∂ffnet hat!</span>`;
    }
  },15000);
}

function startGame(){
  menu.style.display='none';
  canvas.style.display='block';
  scoresDiv.style.display='block';
  gameOn=true;myScore=0;theirScore=0;updateScores();
  showMsg("LOS GEHT'S! üèì");
  if(isHost)resetBall();
  requestAnimationFrame(loop);
}

function resetBall(){state.ball={x:300,y:200,vx:(Math.random()>0.5?1:-1)*5,vy:(Math.random()-0.5)*6};}

function updateScores(){
  document.getElementById('s1').textContent=myScore;
  document.getElementById('s2').textContent=theirScore;
}

function showMsg(t){gmsg.textContent=t;gmsg.style.opacity=1;setTimeout(()=>gmsg.style.opacity=0,1500);}

let frameCnt=0;
function loop(){
  if(!gameOn)return;
  frameCnt++;
  if(frameCnt%2===0)sendPaddle(myY); // throttle sends

  if(isHost){
    state.p1.y=myY;
    let b=state.ball;
    b.x+=b.vx;b.y+=b.vy;
    if(b.y-BR<0){b.y=BR;b.vy=Math.abs(b.vy);}
    if(b.y+BR>CH){b.y=CH-BR;b.vy=-Math.abs(b.vy);}
    if(b.x-BR<PW+10&&b.y>state.p1.y&&b.y<state.p1.y+PH&&b.vx<0){
      b.vx=Math.abs(b.vx)*1.05;b.vy+=(b.y-(state.p1.y+PH/2))*0.15;
    }
    if(b.x+BR>CW-10-PW&&b.y>state.p2.y&&b.y<state.p2.y+PH&&b.vx>0){
      b.vx=-Math.abs(b.vx)*1.05;b.vy+=(b.y-(state.p2.y+PH/2))*0.15;
    }
    let spd=Math.sqrt(b.vx*b.vx+b.vy*b.vy);
    if(spd>15){b.vx*=15/spd;b.vy*=15/spd;}
    if(b.x<0){
      theirScore++;updateScores();
      sendEvent({t:'score',me:theirScore,them:myScore});
      showMsg('DIGGA! üíÄ');sendEvent({t:'msg',text:'JAAAA! üî•'});
      resetBall();
    }
    if(b.x>CW){
      myScore++;updateScores();
      sendEvent({t:'score',me:myScore,them:theirScore});
      showMsg('JAAAA! üî•');sendEvent({t:'msg',text:'DIGGA! üíÄ'});
      resetBall();
    }
    if(frameCnt%2===0)sendState(state);
  }else{
    state.p2.y=myY;
  }
  draw();
  requestAnimationFrame(loop);
}

function draw(){
  ctx.clearRect(0,0,CW,CH);
  ctx.setLineDash([8,8]);ctx.strokeStyle='#333';
  ctx.beginPath();ctx.moveTo(300,0);ctx.lineTo(300,400);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='#0f0';ctx.fillRect(10,state.p1.y,PW,PH);
  ctx.fillStyle='#e94560';ctx.fillRect(CW-10-PW,state.p2.y,PW,PH);
  ctx.fillStyle='#fff';ctx.beginPath();
  ctx.arc(state.ball.x,state.ball.y,BR,0,Math.PI*2);ctx.fill();
}

canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  myY=Math.max(0,Math.min(CH-PH,(e.clientY-r.top)*(CH/r.height)-PH/2));
});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  const r=canvas.getBoundingClientRect();
  myY=Math.max(0,Math.min(CH-PH,(e.touches[0].clientY-r.top)*(CH/r.height)-PH/2));
});
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowUp'||e.key==='w')myY=Math.max(0,myY-20);
  if(e.key==='ArrowDown'||e.key==='s')myY=Math.min(CH-PH,myY+20);
});
</script>
</body>
</html>
